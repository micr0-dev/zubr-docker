FROM node:20-alpine AS builder

ARG ZUBR_WEB_VERSION=master

# Install dependencies with retry
RUN apk update && apk add --no-cache git python3 make g++

# Clone zubr-web
WORKDIR /build
RUN git clone --depth 1 --branch ${ZUBR_WEB_VERSION} https://github.com/micr0-dev/zubr-web.git .

# Update API URL to use 127.0.0.1 (since we share network namespace with zubr-server)
RUN sed -i 's|url: "http://localhost:3000"|url: "http://127.0.0.1:3000"|g' /build/defaults/config.js

# Install dependencies and build
RUN yarn install --frozen-lockfile --network-timeout 100000
RUN NODE_ENV=production yarn build

# Runtime stage
FROM node:20-alpine

# Install runtime dependencies
RUN apk update && apk add --no-cache tini curl

# Copy built application
WORKDIR /app
COPY --from=builder /build /app

# Create user
RUN addgroup -g 10000 -S thelounge && \
    adduser -u 10000 -S -G thelounge -h /app thelounge && \
    chown -R thelounge:thelounge /app

USER thelounge

# Expose port
EXPOSE 9000

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=20s --retries=3 \
    CMD curl -f http://localhost:9000 || exit 1

# Use tini for proper signal handling
ENTRYPOINT ["/sbin/tini", "--"]

# Start the application
CMD ["yarn", "start"]